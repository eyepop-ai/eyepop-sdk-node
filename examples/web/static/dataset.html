<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dataset Testing </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="main.css" rel="stylesheet">

    <!--    <script src="https://cdn.jsdelivr.net/npm/@eyepop.ai/eyepop/dist/eyepop.min.js"></script>-->
    <script src="/src/eyepop-data/dist/eyepopdata.min.js"></script>
</head>

<body>
    <div class="jumbotron vertical-center">
        <div class="container-fluid mt-4">
            <div class="row" style="width: 100%">
                <div class="col text-center" id="list-datasets">
                    <h1 class="display-4">List Datasets</h1>
                    <button class="btn btn-primary" id="new-datasets-btn">+ Dataset</button><br /><br />
                    <div id="list-datasets-result"></div>
                </div>
            </div>
            <div class="row mt-2" style="width: 100%">
                <div class="col text-center" id="list-assets">
                    <h1 class="display-4">Asset Viewer</h1>
                    <div id="list-assets-result"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        //console.log(EyePopData);

        const api_key = 'AAGcsWj8N2PlKQl9c9ydz3QFZ0FBQUFBQm1mZDB5eDUwalNlYi12NWotd3hsVGJiMW1sVXF1dE9aOU9oSGVBOWtBQXoxZmNjUE5Nb1YzY3RROUdzbVUwUkZtcDhZcG5vSWROTzR1TU8ybGhZckx6RTgzYVZwMjZEREZjalZubnpYaUNMWVdBODg9';
        const token = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InZUdzF6bi02cjFPcXg0NmNxRl9PMiJ9.eyJodHRwczovL2NsYWltcy5leWVwb3AuYWkvZ3JhbnRzIjpbeyJwZXJtaXNzaW9uIjoiYWNjZXNzOmRhdGFzZXRzIiwidGFyZ2V0IjoiYWNjb3VudDphbmR5In0seyJwZXJtaXNzaW9uIjoiYWNjZXNzOmRhdGFzZXRzIiwidGFyZ2V0IjoiYWNjb3VudDpmb28ifSx7InBlcm1pc3Npb24iOiJhY2Nlc3M6aW5mZXJlbmNlLWFwaSIsInRhcmdldCI6InVzZXI6YXV0aDB8NjRjNDJhYjk4NzRkZTc4ZDJlOWYzZTRhIn1dLCJpc3MiOiJodHRwczovL2Rldi1leWVwb3AudXMuYXV0aDAuY29tLyIsInN1YiI6ImF1dGgwfDY0YzQyYWI5ODc0ZGU3OGQyZTlmM2U0YSIsImF1ZCI6Imh0dHBzOi8vZGV2LWFwcC5leWVwb3AuYWkiLCJpYXQiOjE3MTk4NzQ2NDAsImV4cCI6MTcxOTg4MTg0MCwic2NvcGUiOiJhY2Nlc3M6ZGF0YXNldHMiLCJhenAiOiJJVXQwcHMybWFXWlVkRW1FT1BSYVBKS3ZrUVRzNllVRSIsInBlcm1pc3Npb25zIjpbImFjY2VzczpkYXRhc2V0cyIsImFkbWluOmNsb3VkcyJdfQ.l3aVxPeRp0bbe1nDA7BdtHb0GQV07-xRaMgQlDQlxVNzT3m713COmQYb_Nymzy3RE2MQ-PeUQBJSadPELLYhfYacisAp1D3aL_yBmlw_ztEMviNgcZRmMWk6y1mzsEFD39Zl7uDs3E5ScOcpp59wiW9j50REuCQd8THHzo-3-wrJ0uJ0OALGIJuyeg6GhXJ7k_VK4dbMfAgZmPMUshiprP9q78qEK4ehwMzBdoKIZ_Nv6rfiv6sp5jn0qMlbhV4mzHjjKpzTZTX2UUQ4EfdL7r_zLQ7Ttg8KfE6sSGrRvX1d211VUSP9wfSSjr116rk8H_rz2Y2JxIzWIQu6nFt1ow";

        const account_uuid = "foo";

        async function SubscriberDataset(data) {
            console.log("SubscriberDataset", data);
        }

        async function setup() {
            // auth: {'secretKey': api_key} 
            var endpoint = await EyePopData.endpoint({
                //auth: {oAuth2: true},
                auth: { 'secretKey': api_key },
                passedToken: token,
                eyepopDataUrl: 'https://data.api.eyepop.xyz'
            }).connect();

            // Test healthz function
            endpoint.healthz()
                .then((res) => console.log("TEST HEALTHZ", res));

            listDatasets(endpoint);

            console.log("Subbing to account", account_uuid)
            endpoint.subscribeCallbackToAccountEvents(account_uuid, SubscriberDataset);

            //implement the new dataset button
            var newDatasetsButton = document.getElementById('new-datasets-btn');
            newDatasetsButton.onclick = function () {
                //create a new dataset
                const datasetCreateData = {
                    // dataset create data
                    "name": "Andy Dataset",
                    "description": "test dataset from Andy",
                    "tags": [
                        "test1"
                    ]
                };
                endpoint.createDataset(account_uuid, datasetCreateData)
                    .then((res) => {
                        console.log("TEST CREATE DATASET", res);
                        listAssets(endpoint);
                    });
            }


        }

        function listAssets(endpoint, dataset, version) {
            endpoint.listAssets(dataset.uuid, version, true)
                .then((res) => {
                    console.log("TEST LIST ASSETS", res);
                    //add assets to the list
                    var listAssetsResult = document.getElementById('list-assets-result');
                    listAssetsResult.innerHTML = '';

                    const version = dataset.versions.find(v => v.modifiable)?.version || null;


                    //for each asset in the dataset
                    res.forEach((asset) => {
                        var assetDiv = document.createElement('div');
                        assetDiv.innerHTML = asset.uuid;


                        listAssetsResult.appendChild(assetDiv);
                        if (asset.status == "rejected") {
                            assetDiv.innerHTML += "(rejected)"
                            return;

                        } if (asset.status == "transform_in_progress") {
                            assetDiv.innerHTML += "(loading...)"
                        } else {
                            //download the asset and show in img tag
                            endpoint.downloadAsset(asset.uuid, dataset.uuid, version, 'image_cover_224')
                                .then((res) => {
                                    console.log("TEST DOWNLOAD ASSET", res);
                                    var img = document.createElement('img');

                                    console.log("res", res)

                                    img.src = URL.createObjectURL(res);
                                    assetDiv.appendChild(document.createElement('br'));
                                    assetDiv.appendChild(img);
                                });
                        }


                        //add delete button to each asset
                        var deleteAssetButton = document.createElement('button');
                        deleteAssetButton.innerHTML = "Delete";
                        deleteAssetButton.onclick = function () {
                            endpoint.deleteAsset(asset.uuid, dataset.uuid, version)
                                .then((res) => {
                                    console.log("TEST DELETE ASSET", res);
                                    //remove the asset from the list
                                    assetDiv.remove();
                                    deleteAssetButton.remove();
                                });
                        };
                        listAssetsResult.appendChild(deleteAssetButton);

                        //add download button to each asset
                        var downloadAssetButton = document.createElement('button');
                        downloadAssetButton.innerHTML = "Download";
                        downloadAssetButton.onclick = function () {
                            endpoint.downloadAsset(asset.uuid, dataset.uuid, version, 'original')
                                .then((res) => {
                                    console.log("TEST DOWNLOAD ASSET", res);
                                });
                        };
                        listAssetsResult.appendChild(downloadAssetButton);

                        //add get asset button to each asset
                        var getAssetButton = document.createElement('button');
                        getAssetButton.innerHTML = "Get Asset";
                        getAssetButton.onclick = function () {
                            endpoint.getAsset(asset.uuid, dataset.uuid, version, true)
                                .then((res) => {
                                    console.log("TEST GET ASSET", res);
                                });
                        };
                        listAssetsResult.appendChild(getAssetButton);

                        //add update asset manual annotation button to each asset
                        var updateAssetManualAnnotationButton = document.createElement('button');
                        updateAssetManualAnnotationButton.innerHTML = "Update Asset Manual Annotation";
                        updateAssetManualAnnotationButton.onclick = function () {
                            const annotation = {
                                // annotation data
                            };
                            endpoint.updateAssetManualAnnotation(asset.uuid, dataset.uuid, version, annotation)
                                .then((res) => {
                                    console.log("TEST UPDATE ASSET MANUAL ANNOTATION", res);
                                });
                        };
                        listAssetsResult.appendChild(updateAssetManualAnnotationButton);
                        listAssetsResult.appendChild(document.createElement('br'));
                        listAssetsResult.appendChild(document.createElement('br'));
                    });

                    
                });
                        
        }

        function listDatasets(endpoint) {
            // Test listDatasets function
            //on page load load the datasets into the list
            endpoint.listDatasets(account_uuid)
                .then((res) => {
                    console.log("TEST LIST DATASETS", res);
                    var listDatasetsResult = document.getElementById('list-datasets-result');
                    listDatasetsResult.innerHTML = '';
                    res.forEach((dataset) => {
                        var datasetDiv = document.createElement('div');
                        datasetDiv.innerHTML = "<span style='font-weight: bold; font-size: larger;'>" + dataset.name + "</span><br /> " + dataset.uuid;
                        listDatasetsResult.appendChild(datasetDiv);
                        //add delete button to each dataset
                        var deleteButton = document.createElement('button');
                        deleteButton.innerHTML = "Delete";
                        deleteButton.onclick = function () {
                            endpoint.deleteDataset(dataset.uuid)
                                .then((res) => {
                                    console.log("TEST DELETE DATASET", res);
                                    listAssets(endpoint);
                                });
                        };
                        listDatasetsResult.appendChild(deleteButton);

                        //add upload button to each dataset
                        var uploadButton = document.createElement('button');
                        uploadButton.innerHTML = "Upload";
                        uploadButton.onclick = function () {
                            const version = dataset.versions.find(v => v.modifiable)?.version || null;

                            const file = createFileFromLocalURL('./images/Hot_dog_with_mustard.png')
                                .then((file) => {
                                    console.log("file", file)
                                    endpoint.uploadAsset(dataset.uuid, version, file)
                                        .then((res) => {
                                            console.log("TEST UPLOAD ASSET", res);
                                        });
                                });
                        };
                        listDatasetsResult.appendChild(uploadButton);

                        //add list assets button to each dataset
                        var listAssetsButton = document.createElement('button');
                        listAssetsButton.innerHTML = "List Assets";
                        const version = dataset.versions.find(v => v.modifiable)?.version || null;

                        listAssetsButton.onclick = function () {

                            console.log("Subbing to dataset", dataset.uuid)
                            endpoint.subscribeCallbackToDatasetEvents(dataset.uuid, SubscriberDataset);

                            listAssets(endpoint, dataset, version)

                        }
                        listDatasetsResult.appendChild(listAssetsButton);


                        //add list models button to each dataset
                        var listModelsButton = document.createElement('button');
                        listModelsButton.innerHTML = "List Models";
                        listModelsButton.onclick = function () {
                            endpoint.listModels(account_uuid)
                                .then((res) => {
                                    console.log("TEST LIST MODELS", res);
                                });
                        };
                        listDatasetsResult.appendChild(listModelsButton);

                        //add get dataset button to each dataset
                        var getDatasetButton = document.createElement('button');
                        getDatasetButton.innerHTML = "Get Dataset";
                        getDatasetButton.onclick = function () {
                            endpoint.getDataset(dataset.uuid)
                                .then((res) => {
                                    console.log("TEST GET DATASET", res);
                                });
                        };

                        listDatasetsResult.appendChild(document.createElement('br'));
                        listDatasetsResult.appendChild(document.createElement('br'));
                    });
                });

        }




        // }

        setup();

        async function createFileFromLocalURL(fileURL) {
            try {
                // Fetch the file data
                const response = await fetch(fileURL);
                const blob = await response.blob();

                // Extract the filename from the URL
                const urlParts = fileURL.split('/');
                const filename = urlParts[urlParts.length - 1];

                // Create a File object
                const file = new File([blob], filename, { type: blob.type });

                return file;
            } catch (error) {
                console.error('Error creating file from local URL:', error);
            }
        }
    </script>
</body>

</html>