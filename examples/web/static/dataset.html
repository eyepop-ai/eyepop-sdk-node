<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dataset Testing </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="main.css" rel="stylesheet">

    <!--    <script src="https://cdn.jsdelivr.net/npm/@eyepop.ai/eyepop/dist/eyepop.min.js"></script>-->
    <script src="/src/eyepop-data/dist/eyepopdata.min.js"></script>
    <script src="/src/eyepop-render-2d/dist/eyepop.render2d.min.js"></script>

</head>

<body>
    <div class="jumbotron vertical-center">
        <div class="container-fluid mt-4">
            <div class="row" style="width: 100%">
                <div class="col text-center" id="list-datasets">
                    <h1 class="display-4">List Datasets</h1>
                    <button class="btn btn-primary" id="new-datasets-btn">+ Dataset</button><br /><br />
                    <div id="list-datasets-result"></div>
                </div>
            </div>
            <div class="row mt-2" style="width: 100%">
                <div class="col text-center" id="list-assets">
                    <h1 class="display-4">Asset Viewer</h1>
                    <div id="list-assets-result"></div>
                </div>
            </div>
        </div>
    </div>
    <script>

        const api_key = null //'AAGcsWj8N2PlKQl9c9ydz3QFZ0FBQUFBQm1mZDB5eDUwalNlYi12NWotd3hsVGJiMW1sVXF1dE9aOU9oSGVBOWtBQXoxZmNjUE5Nb1YzY3RROUdzbVUwUkZtcDhZcG5vSWROTzR1TU8ybGhZckx6RTgzYVZwMjZEREZjalZubnpYaUNMWVdBODg9';
        const token = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InZUdzF6bi02cjFPcXg0NmNxRl9PMiJ9.eyJodHRwczovL2NsYWltcy5leWVwb3AuYWkvZ3JhbnRzIjpbeyJwZXJtaXNzaW9uIjoiYWNjZXNzOmRhdGFzZXRzIiwidGFyZ2V0IjoiYWNjb3VudDphbmR5In0seyJwZXJtaXNzaW9uIjoiYWNjZXNzOmRhdGFzZXRzIiwidGFyZ2V0IjoiYWNjb3VudDpmb28ifSx7InBlcm1pc3Npb24iOiJhY2Nlc3M6aW5mZXJlbmNlLWFwaSIsInRhcmdldCI6InVzZXI6YXV0aDB8NjRjNDJhYjk4NzRkZTc4ZDJlOWYzZTRhIn1dLCJpc3MiOiJodHRwczovL2Rldi1leWVwb3AudXMuYXV0aDAuY29tLyIsInN1YiI6ImF1dGgwfDY0YzQyYWI5ODc0ZGU3OGQyZTlmM2U0YSIsImF1ZCI6Imh0dHBzOi8vZGV2LWFwcC5leWVwb3AuYWkiLCJpYXQiOjE3MjAwMzA0NDIsImV4cCI6MTcyMDAzNzY0Miwic2NvcGUiOiJhY2Nlc3M6ZGF0YXNldHMiLCJhenAiOiJJVXQwcHMybWFXWlVkRW1FT1BSYVBKS3ZrUVRzNllVRSIsInBlcm1pc3Npb25zIjpbImFjY2VzczpkYXRhc2V0cyIsImFkbWluOmNsb3VkcyJdfQ.aMTg10xUcCvS7UH9HI_o-HYq2VM_yTTvn7Ue87gWdKLMYnYzs1AYGVF3jv3PWVrhW70e8YMLhNP5LDahq1gXhBlUE_8LkZB79OUs2h5SChChemqxVopR9UOXcjT8HFvJEKUO2wIuxfJ9iFzu8Mez63UWye1-N-37R2NKpJsI3UjMM66b0_KLb0Z9yErmro37eHtUhBVVabCRa3u0QvJVm_p1J3SFgth1vApzu449hulw8gBGLrRzM6RkOdYeoqnfJkCIw9dSVLAeg7o9oamNMNX93d6c2e4OUEUA7ZZ4SZasNlirJcZupaEpy540xyga0l_N4zAdAHNTWUWJNYqFWA";
        const account_uuid = "foo";

        var currDataset = null;
        var endpoint = null;

        async function SubscriberDataset(data)
        {
            console.log("SubscriberDataset", data);

            if (currDataset)
            {
                listAssets(endpoint, currDataset);
            }
        }

        async function SubscriberAccount(data)
        {
            console.log("SubscriberDataset", data);

            listDatasets(endpoint);
        }

        async function setup()
        {
            // auth: {'secretKey': api_key} 
            endpoint = await EyePopData.endpoint({
                //auth: {oAuth2: true},
                auth: { 'secretKey': api_key },
                passedToken: token,
                eyepopDataUrl: 'https://data.api.eyepop.xyz'
            }).connect();

            // Test healthz function
            endpoint.healthz();

            listDatasets(endpoint);

            console.log("Subbing to account", account_uuid)
            endpoint.subscribeCallbackToAccountEvents(account_uuid, SubscriberDataset);

            //implement the new dataset button
            var newDatasetsButton = document.getElementById('new-datasets-btn');
            newDatasetsButton.onclick = function ()
            {
                //create a new dataset
                const datasetCreateData = {
                    // dataset create data
                    "name": "Andy Dataset",
                    "description": "test dataset from Andy",
                    "tags": [
                        "test1"
                    ],
                    "auto_annotates": [
                        "ep_coco", "ep_rapid_medical"
                    ]
                };
                endpoint.createDataset(account_uuid, datasetCreateData)
                    .then((res) =>
                    {
                        console.log("TEST CREATE DATASET", res);
                        listDatasets(endpoint);
                        listAssets(endpoint, res);

                        currDataset = res;
                    });
            }


        }

        function listAssets(endpoint, dataset, version)
        {
            currDataset = dataset;
            endpoint.listAssets(dataset.uuid, version, true)
                .then((res) =>
                {
                    console.log("TEST LIST ASSETS", res);
                    //add assets to the list
                    var listAssetsResult = document.getElementById('list-assets-result');
                    listAssetsResult.innerHTML = '';

                    const version = dataset.versions.find(v => v.modifiable)?.version || null;


                    //for each asset in the dataset
                    res.forEach((asset) =>
                    {
                        var assetDiv = document.createElement('div');
                        assetDiv.innerHTML = asset.uuid;


                        listAssetsResult.appendChild(assetDiv);
                        if ([ "rejected", "upload_in_progress", "upload_failed", "transform_failed", "transform_in_progress" ].includes(asset.status))
                        {
                            assetDiv.innerHTML += "(" + asset.status + ")";
                            return;
                        } else
                        {
                            //download the asset and show in img tag
                            endpoint.downloadAsset(asset.uuid, dataset.uuid, version, 'image_cover_224')
                                .then((res) =>
                                {
                                    console.log("TEST DOWNLOAD ASSET", res);
                                    var img = document.createElement('img');

                                    console.log("res", res)

                                    //instead of an img I want a canvas here
                                    var canvas = document.createElement('canvas');
                                    var ctx = canvas.getContext('2d');
                                    var img = new Image();
                                    img.onload = function ()
                                    {
                                        canvas.width = img.width;
                                        canvas.height = img.height;
                                        ctx.drawImage(img, 0, 0);

                                        if (asset.annotations)
                                        {
                                            const renderer = Render2d.renderer(ctx)
                                            asset.annotations.forEach((ann) =>
                                            {
                                                console.log("ann", ann.annotation);
                                                renderer.draw(ann.annotation);
                                            });
                                        }

                                    };
                                    img.src = URL.createObjectURL(res);

                                    assetDiv.appendChild(document.createElement('br'));
                                    assetDiv.appendChild(canvas);
                                    assetDiv.appendChild(document.createElement('br'));
                                });
                        }


                        //add delete button to each asset
                        var deleteAssetButton = document.createElement('button');
                        deleteAssetButton.innerHTML = "Delete";
                        deleteAssetButton.onclick = function ()
                        {
                            endpoint.deleteAsset(asset.uuid, dataset.uuid, version)
                                .then((res) =>
                                {
                                    console.log("TEST DELETE ASSET", res);
                                    //remove the asset from the list
                                    assetDiv.remove();
                                    deleteAssetButton.remove();

                                    listAssets(endpoint, currDataset, version);
                                });
                        };
                        listAssetsResult.appendChild(deleteAssetButton);

                        //add download button to each asset
                        var downloadAssetButton = document.createElement('button');
                        downloadAssetButton.innerHTML = "Download";
                        downloadAssetButton.onclick = function ()
                        {
                            endpoint.downloadAsset(asset.uuid, dataset.uuid, version, 'original')
                                .then((res) =>
                                {
                                    console.log("TEST DOWNLOAD ASSET", res);
                                });
                        };
                        listAssetsResult.appendChild(downloadAssetButton);

                        //add get asset button to each asset
                        var getAssetButton = document.createElement('button');
                        getAssetButton.innerHTML = "Get Asset";
                        getAssetButton.onclick = function ()
                        {
                            endpoint.getAsset(asset.uuid, dataset.uuid, version, true)
                                .then((res) =>
                                {
                                    console.log("TEST GET ASSET", res);
                                });
                        };
                        listAssetsResult.appendChild(getAssetButton);

                        //add update asset manual annotation button to each asset
                        var updateAssetManualAnnotationButton = document.createElement('button');
                        updateAssetManualAnnotationButton.innerHTML = "Update Asset Manual Annotation";
                        updateAssetManualAnnotationButton.onclick = function ()
                        {
                            const annotation = {
                                // annotation data
                            };
                            endpoint.updateAssetManualAnnotation(asset.uuid, dataset.uuid, version, annotation)
                                .then((res) =>
                                {
                                    console.log("TEST UPDATE ASSET MANUAL ANNOTATION", res);
                                });
                        };
                        listAssetsResult.appendChild(updateAssetManualAnnotationButton);
                        listAssetsResult.appendChild(document.createElement('br'));
                        listAssetsResult.appendChild(document.createElement('br'));
                    });


                });

        }

        function listDatasets(endpoint)
        {
            // Test listDatasets function
            //on page load load the datasets into the list
            endpoint.listDatasets(account_uuid)
                .then((res) =>
                {
                    console.log("TEST LIST DATASETS", res);
                    var listDatasetsResult = document.getElementById('list-datasets-result');
                    listDatasetsResult.innerHTML = '';
                    res.forEach((dataset) =>
                    {
                        var datasetDiv = document.createElement('div');
                        datasetDiv.innerHTML = "<span style='font-weight: bold; font-size: larger;'>" + dataset.name + "</span><br /> " + dataset.uuid;
                        listDatasetsResult.appendChild(datasetDiv);
                        //add delete button to each dataset
                        var deleteButton = document.createElement('button');
                        deleteButton.innerHTML = "Delete";
                        deleteButton.onclick = function ()
                        {
                            endpoint.deleteDataset(dataset.uuid)
                                .then((res) =>
                                {
                                    console.log("TEST DELETE DATASET", res);

                                    listDatasets(endpoint);
                                    currDataset = null;
                                    //clear the assets list
                                    var listAssetsResult = document.getElementById('list-assets-result');
                                    listAssetsResult.innerHTML = '';
                                    
                                });
                        };
                        listDatasetsResult.appendChild(deleteButton);

                        //add upload button to each dataset
                        var uploadButton = document.createElement('button');
                        uploadButton.innerHTML = "Upload";
                        uploadButton.onclick = function ()
                        {
                            const version = dataset.versions.find(v => v.modifiable)?.version || null;

                            const file = createFileFromLocalURL('./images/Hot_dog_with_mustard.png')
                                .then((file) =>
                                {
                                    console.log("file", file)
                                    endpoint.uploadAsset(dataset.uuid, version, file)
                                        .then((res) =>
                                        {
                                            console.log("TEST UPLOAD ASSET", res);
                                        });
                                });
                        };
                        listDatasetsResult.appendChild(uploadButton);

                        //add list assets button to each dataset
                        var listAssetsButton = document.createElement('button');
                        listAssetsButton.innerHTML = "List Assets";
                        const version = dataset.versions.find(v => v.modifiable)?.version || null;

                        listAssetsButton.onclick = function ()
                        {

                            console.log("Subbing to dataset", dataset.uuid)
                            endpoint.subscribeCallbackToDatasetEvents(dataset.uuid, SubscriberDataset);

                            listAssets(endpoint, dataset, version)

                        }
                        listDatasetsResult.appendChild(listAssetsButton);


                        //add list models button to each dataset
                        var listModelsButton = document.createElement('button');
                        listModelsButton.innerHTML = "List Models";
                        listModelsButton.onclick = function ()
                        {
                            endpoint.listModels(account_uuid)
                                .then((res) =>
                                {
                                    console.log("TEST LIST MODELS", res);
                                });
                        };
                        listDatasetsResult.appendChild(listModelsButton);

                        //add get dataset button to each dataset
                        var getDatasetButton = document.createElement('button');
                        getDatasetButton.innerHTML = "Get Dataset";
                        getDatasetButton.onclick = function ()
                        {
                            endpoint.getDataset(dataset.uuid)
                                .then((res) =>
                                {
                                    console.log("TEST GET DATASET", res);
                                });
                        };

                        listDatasetsResult.appendChild(document.createElement('br'));
                        listDatasetsResult.appendChild(document.createElement('br'));
                    });
                });

        }




        // }

        setup();

        async function createFileFromLocalURL(fileURL)
        {
            try
            {
                // Fetch the file data
                const response = await fetch(fileURL);
                const blob = await response.blob();

                // Extract the filename from the URL
                const urlParts = fileURL.split('/');
                const filename = urlParts[ urlParts.length - 1 ];

                // Create a File object
                const file = new File([ blob ], filename, { type: blob.type });

                return file;
            } catch (error)
            {
                console.error('Error creating file from local URL:', error);
            }
        }
    </script>
</body>

</html>
